
#include "cnn_one_fstride4.h"
#include "arm_stat_fcn.h"
#include <math.h>
#include <stdint.h>
#include <stdio.h>

#define RELU(x) (x = x > 0? x : 0)

float feature_maps[186][9][1];//__attribute__((section(".ARM.__at_0xC0000000")));
float fc_buffer1[128];
float fc_buffer2[128];

// float spectrogram[40][30];

float spectrogram[40][30] =
        {
                {-16.836448669433594, -21.349891662597656, -15.525350570678711, -18.69580078125, -13.046661376953125, -21.54216766357422, -19.4978084564209, -17.9857177734375, -17.187732696533203, -20.609134674072266, -22.843101501464844, -22.592693328857422, -9.386754989624023, -6.821979999542236, -3.955789804458618, -11.33714771270752, -4.848934173583984, -3.0282881259918213, -0.34949904680252075, 6.261429309844971, -10.415380477905273, -17.654644012451172, -20.229063034057617, -18.311126708984375, -19.265506744384766, -21.156585693359375, -19.048383712768555, -31.715669631958008, -20.241727828979492, -25.00969123840332, },
                {-9.453693389892578, -17.787025451660156, -9.844847679138184, -14.697190284729004, -8.833474159240723, -14.765180587768555, -16.287263870239258, -12.521520614624023, -14.870969772338867, -12.941737174987793, -15.088827133178711, -8.897446632385254, -0.34166640043258667, 3.05031418800354, 9.278322219848633, 9.343629837036133, 16.29422950744629, 19.88524055480957, 22.727956771850586, 24.165428161621094, 9.22249698638916, -1.9677128791809082, -10.853461265563965, -11.679630279541016, -12.028512001037598, -15.471224784851074, -11.485570907592773, -26.90057945251465, -13.832286834716797, -19.004953384399414, },
                {-37.70737075805664, -44.1630973815918, -32.49420166015625, -42.72270584106445, -41.44062423706055, -37.965274810791016, -40.38003921508789, -45.385833740234375, -50.36180114746094, -35.97556686401367, -30.86145782470703, -11.954376220703125, -6.410013198852539, -5.496597766876221, -1.7889034748077393, -6.584903717041016, -0.996229350566864, 1.4470659494400024, 4.6760172843933105, 14.98985767364502, 1.1541368961334229, -12.611572265625, -20.462291717529297, -27.367698669433594, -34.4938850402832, -35.38174057006836, -26.77109718322754, -38.52070999145508, -44.54899215698242, -40.051727294921875, },
                {-48.8187255859375, -48.76716995239258, -46.21345901489258, -55.28183364868164, -48.360557556152344, -46.55853271484375, -44.410400390625, -52.928497314453125, -57.16658020019531, -46.572021484375, -37.79080581665039, -11.73828125, -7.8841633796691895, -2.999899387359619, 5.384904861450195, 7.807986259460449, 15.067139625549316, 17.902877807617188, 21.158788681030273, 28.414899826049805, 9.296669960021973, -0.5575217008590698, -21.81858253479004, -33.86307144165039, -44.87969207763672, -47.01643371582031, -46.76329040527344, -56.12042999267578, -45.118438720703125, -46.85798645019531, },
                {-51.166969299316406, -57.49467849731445, -57.700469970703125, -57.24079513549805, -53.781394958496094, -62.423458099365234, -53.96674346923828, -59.266517639160156, -53.62192153930664, -60.66749572753906, -45.147422790527344, -13.434564590454102, 2.2671759128570557, 4.467735767364502, 4.858434677124023, -14.910417556762695, -0.8905787467956543, 6.59124755859375, 6.966426849365234, -2.021904468536377, -5.225460529327393, -20.308635711669922, -36.5921630859375, -47.636375427246094, -52.456581115722656, -52.431697845458984, -54.51567077636719, -60.626678466796875, -49.62177658081055, -53.86250305175781, },
                {-59.40395736694336, -69.63221740722656, -69.00025939941406, -60.50945281982422, -72.6310043334961, -63.027931213378906, -64.9453125, -67.51626586914062, -66.98902893066406, -66.34341430664062, -35.491363525390625, -9.368529319763184, -3.984250783920288, 3.0810928344726562, 8.800469398498535, -0.05347539111971855, 14.156893730163574, 21.4881534576416, 23.831462860107422, 2.2317941188812256, 3.1800994873046875, -12.058595657348633, -32.9815788269043, -48.53997802734375, -55.53482437133789, -46.18211364746094, -50.80322265625, -63.788089752197266, -64.0027084350586, -71.84986877441406, },
                {-68.80660247802734, -82.56079864501953, -80.70270538330078, -73.26908874511719, -74.18026733398438, -68.66737365722656, -68.35548400878906, -74.27056884765625, -70.91288757324219, -68.75901794433594, -45.04265594482422, -20.459653854370117, -5.055115699768066, -7.0179643630981445, 23.311363220214844, 15.541182518005371, 25.05577850341797, 20.111005783081055, 1.1318457126617432, -21.29035186767578, -24.765926361083984, -40.98442840576172, -51.134151458740234, -53.87586212158203, -58.94947814941406, -49.2966423034668, -58.87807846069336, -71.28024291992188, -69.9566879272461, -79.3468017578125, },
                {-68.32643127441406, -79.59657287597656, -75.67438507080078, -75.19196319580078, -72.73347473144531, -77.40524291992188, -72.10972595214844, -65.45299530029297, -82.3238296508789, -73.21221923828125, -63.38037109375, -23.77507209777832, -25.207775115966797, -16.50090789794922, 29.27446174621582, 34.08456802368164, 39.1875, 30.178028106689453, 8.365217208862305, -17.337732315063477, -25.6297607421875, -36.80350875854492, -51.65674591064453, -53.480567932128906, -53.833030700683594, -44.32902908325195, -55.14244079589844, -60.63440704345703, -75.70121765136719, -74.33514404296875, },
                {-70.85323333740234, -75.73562622070312, -70.51693725585938, -69.6375732421875, -74.58231353759766, -80.19196319580078, -73.20127868652344, -68.53655242919922, -79.00350952148438, -78.45704650878906, -53.95151138305664, -37.57821273803711, -29.376935958862305, -20.325307846069336, -5.792088508605957, 8.69056224822998, 8.62329387664795, 0.9363612532615662, -21.61945152282715, -32.80580520629883, -55.10577392578125, -61.22351837158203, -69.09453582763672, -54.26041030883789, -52.685813903808594, -49.6019287109375, -57.517333984375, -63.77958297729492, -74.00699615478516, -72.31092071533203, },
                {-77.05901336669922, -84.04881286621094, -76.0091781616211, -83.97673797607422, -79.87661743164062, -80.29020690917969, -70.86444091796875, -74.34944915771484, -75.61563110351562, -82.97232055664062, -59.29798126220703, -26.27060317993164, -19.397558212280273, -12.76538372039795, -10.644947052001953, 16.21578598022461, 17.487497329711914, 5.840170383453369, -15.244468688964844, -26.462583541870117, -50.53437042236328, -43.60197448730469, -58.23995590209961, -61.75388717651367, -58.722129821777344, -66.91670227050781, -69.40164947509766, -71.06062316894531, -72.65960693359375, -67.69766235351562, },
                {-80.83076477050781, -78.07997131347656, -73.46442413330078, -74.45975494384766, -76.9124526977539, -79.4363021850586, -73.69581604003906, -72.14970397949219, -73.96939849853516, -68.15789794921875, -49.653709411621094, -13.17820930480957, -16.311471939086914, -5.52948522567749, 3.9993839263916016, 1.028956413269043, -6.2650322914123535, -15.546148300170898, -31.437185287475586, -37.020179748535156, -51.046546936035156, -62.49028015136719, -69.32706451416016, -55.02851104736328, -53.31739044189453, -48.68169403076172, -51.933631896972656, -62.65763854980469, -57.68281936645508, -71.47956848144531, },
                {-78.61502838134766, -80.3787612915039, -68.50828552246094, -63.32976531982422, -73.9423828125, -70.55146789550781, -82.18376159667969, -83.55030059814453, -74.10445404052734, -73.9260482788086, -55.40269470214844, -33.02931213378906, -29.578018188476562, -20.349740982055664, 2.7816715240478516, 11.177106857299805, -0.5473331809043884, -9.94952392578125, -19.78426742553711, -27.88817596435547, -45.55181121826172, -65.51751708984375, -64.99433135986328, -55.128868103027344, -57.203208923339844, -50.85929870605469, -48.532405853271484, -50.358665466308594, -66.42207336425781, -76.48799133300781, },
                {-82.77420043945312, -84.14616394042969, -77.97352600097656, -71.41812133789062, -77.63296508789062, -75.40475463867188, -84.39781188964844, -78.43659210205078, -78.53974914550781, -74.41480255126953, -69.93329620361328, -56.066307067871094, -24.8562068939209, -14.798497200012207, 0.7819873094558716, 8.647395133972168, -7.733328342437744, -18.118824005126953, -47.583229064941406, -46.188072204589844, -64.58983612060547, -71.86766052246094, -77.25466918945312, -51.44544219970703, -44.87995529174805, -46.14439392089844, -44.759666442871094, -54.731441497802734, -79.14104461669922, -72.87687683105469, },
                {-78.6969985961914, -72.2169418334961, -79.21711730957031, -72.84359741210938, -78.80230712890625, -68.68193817138672, -76.23702239990234, -80.0455322265625, -76.40170288085938, -81.18434143066406, -71.07745361328125, -48.82548522949219, -31.352947235107422, -7.57759952545166, -1.5218007564544678, 21.333831787109375, 6.999856948852539, -9.038105964660645, -37.38837814331055, -45.00065231323242, -62.03778839111328, -61.02130126953125, -77.1767807006836, -50.09515380859375, -45.99244689941406, -45.224952697753906, -45.813411712646484, -64.40125274658203, -76.58492279052734, -72.20307922363281, },
                {-81.42080688476562, -73.49732971191406, -78.15257263183594, -82.29137420654297, -82.49232482910156, -76.12188720703125, -79.42416381835938, -89.94657897949219, -80.4880142211914, -83.37460327148438, -82.09504699707031, -58.90843200683594, -48.93043518066406, -14.346195220947266, 2.551250457763672, -3.8605833053588867, -19.34490394592285, -36.778831481933594, -49.34064865112305, -57.5845947265625, -63.03224563598633, -72.32608032226562, -78.11848449707031, -59.39962387084961, -61.001197814941406, -65.27791595458984, -59.369956970214844, -80.52100372314453, -76.3663558959961, -78.5357437133789, },
                {-82.67893981933594, -85.48249053955078, -80.75022888183594, -81.45698547363281, -80.12242126464844, -80.39315032958984, -90.52122497558594, -77.0474624633789, -84.46681213378906, -88.30894470214844, -90.23893737792969, -74.21929931640625, -63.93559265136719, -40.58315658569336, -15.551044464111328, 0.5195183753967285, -14.08784008026123, -37.72919464111328, -45.628875732421875, -61.517112731933594, -74.17304992675781, -73.08418273925781, -81.9407958984375, -67.44577026367188, -63.77490997314453, -66.0805435180664, -71.20945739746094, -74.7975845336914, -81.39128875732422, -79.22211456298828, },
                {-82.38740539550781, -88.93325805664062, -82.08647918701172, -86.48350524902344, -83.06655883789062, -90.90908813476562, -87.11608123779297, -83.50041198730469, -84.53120422363281, -87.23841857910156, -92.08667755126953, -81.69580078125, -68.28459167480469, -45.331016540527344, -19.692747116088867, -18.317577362060547, -9.698716163635254, -24.9775390625, -35.573402404785156, -56.04667282104492, -67.43058013916016, -78.8525390625, -78.87397766113281, -72.89347076416016, -68.65607452392578, -63.8878173828125, -64.48117065429688, -78.0979995727539, -80.71969604492188, -81.20466613769531, },
                {-86.31971740722656, -91.35295867919922, -91.14448547363281, -82.54653930664062, -91.25694274902344, -90.66557312011719, -86.08218383789062, -90.740478515625, -84.01436614990234, -87.27278137207031, -93.34908294677734, -78.13029479980469, -68.20852661132812, -50.29750061035156, -26.949480056762695, -22.994789123535156, -16.256000518798828, -33.38105773925781, -41.794586181640625, -54.73717498779297, -72.2004623413086, -82.59628295898438, -84.14227294921875, -74.30520629882812, -72.02001953125, -61.64813995361328, -60.88121795654297, -77.53147888183594, -88.89027404785156, -86.8302001953125, },
                {-83.92723846435547, -87.00690460205078, -85.92239379882812, -90.99038696289062, -91.82572937011719, -92.84736633300781, -91.2386703491211, -85.34569549560547, -85.38650512695312, -87.29251861572266, -88.92058563232422, -85.24082946777344, -77.7374038696289, -61.95977783203125, -36.104217529296875, -22.89116668701172, -26.740192413330078, -32.08976364135742, -45.37428283691406, -59.26742935180664, -73.40144348144531, -84.04026794433594, -83.03643035888672, -79.5796890258789, -74.49734497070312, -68.29209899902344, -76.77523803710938, -85.65362548828125, -78.88841247558594, -78.13842010498047, },
                {-83.46327209472656, -88.25585174560547, -85.34233093261719, -89.23771667480469, -88.84324645996094, -88.00983428955078, -85.51235961914062, -80.78382873535156, -91.99655151367188, -88.84967041015625, -83.03324890136719, -86.42105102539062, -85.53253173828125, -68.72578430175781, -27.65925407409668, -18.49153709411621, -18.97637176513672, -21.16427993774414, -38.151432037353516, -61.90637969970703, -68.41329193115234, -84.90034484863281, -87.29851531982422, -76.78068542480469, -73.27890014648438, -62.63424301147461, -56.63124084472656, -72.67729949951172, -79.40149688720703, -85.205810546875, },
                {-92.00830078125, -89.50310516357422, -93.08502197265625, -95.31123352050781, -90.35736083984375, -86.38168334960938, -89.90558624267578, -90.5222396850586, -94.30912780761719, -88.6114501953125, -86.24854278564453, -84.60196685791016, -83.43498229980469, -77.71768951416016, -15.90805435180664, -12.891185760498047, 5.675472736358643, 1.210172414779663, -26.573999404907227, -58.85682678222656, -64.47113037109375, -77.46949768066406, -76.98431396484375, -69.30607604980469, -42.54901885986328, -32.7582893371582, -39.49833297729492, -63.856056213378906, -81.60481262207031, -83.72142028808594, },
                {-90.53614807128906, -87.88127899169922, -86.13056182861328, -94.73751068115234, -87.9256820678711, -89.55477905273438, -87.97357177734375, -87.49785614013672, -88.64933776855469, -88.21907043457031, -94.45927429199219, -86.97195434570312, -90.99308776855469, -80.30747985839844, -15.9940824508667, -14.280113220214844, -5.209449768066406, 10.623809814453125, -12.185555458068848, -43.165794372558594, -62.369197845458984, -67.88615417480469, -76.0014419555664, -62.866310119628906, -29.354944229125977, -23.25373077392578, -36.543155670166016, -61.71903610229492, -82.4899673461914, -85.03975677490234, },
                {-90.08438873291016, -88.40635681152344, -89.31150817871094, -94.77677154541016, -89.26081848144531, -92.98629760742188, -87.31033325195312, -85.84477233886719, -90.47715759277344, -91.88937377929688, -96.3656005859375, -86.88111877441406, -88.85263061523438, -85.82096099853516, -38.7011604309082, -13.064529418945312, -16.213104248046875, -0.5604032874107361, -10.205937385559082, -35.583274841308594, -58.67605209350586, -70.4986343383789, -81.81964111328125, -62.76201629638672, -38.57374954223633, -29.671812057495117, -45.38764572143555, -67.71086120605469, -83.4896240234375, -89.71340942382812, },
                {-89.93161010742188, -98.34937286376953, -97.08663940429688, -92.809814453125, -92.58460235595703, -91.59603118896484, -95.12736511230469, -91.61958312988281, -90.32827758789062, -95.58525085449219, -95.71455383300781, -96.20175170898438, -95.00450897216797, -91.10641479492188, -52.788490295410156, -10.492262840270996, -10.50478458404541, -3.5119926929473877, -7.916772842407227, -18.330089569091797, -39.20030212402344, -67.30172729492188, -79.61358642578125, -63.800323486328125, -46.29156494140625, -42.67909622192383, -53.1324348449707, -69.87255859375, -86.77085876464844, -91.87653350830078, },
                {-91.16149139404297, -95.99058532714844, -92.47473907470703, -90.57928466796875, -96.105712890625, -91.02469635009766, -92.4283447265625, -94.51836395263672, -93.82867431640625, -96.5863037109375, -95.21600341796875, -94.95980834960938, -91.85992431640625, -92.40692901611328, -57.29241180419922, -21.424667358398438, -7.049520015716553, -3.8649706840515137, -6.331220626831055, -8.038321495056152, -34.942718505859375, -62.984535217285156, -77.11659240722656, -68.27045440673828, -42.630592346191406, -33.455806732177734, -54.66044998168945, -79.0482406616211, -90.4982681274414, -86.20642852783203, },
                {-97.19334411621094, -94.56643676757812, -93.46805572509766, -91.30752563476562, -93.54032897949219, -91.63501739501953, -93.27439880371094, -93.79533386230469, -99.1560287475586, -97.7094955444336, -99.59245300292969, -93.85151672363281, -87.6534194946289, -92.93313598632812, -59.91983413696289, -29.595624923706055, -13.899165153503418, -11.877365112304688, -9.676139831542969, -20.063865661621094, -33.4510383605957, -60.16508102416992, -78.2412338256836, -69.57160186767578, -36.993465423583984, -25.968402862548828, -42.96019744873047, -63.65399169921875, -82.80950927734375, -87.27047729492188, },
                {-102.2475357055664, -94.39215850830078, -96.76823425292969, -96.13294982910156, -91.67425537109375, -92.55828857421875, -91.26739501953125, -100.59383392333984, -91.91629028320312, -96.32818603515625, -97.32098388671875, -91.87987518310547, -91.08390045166016, -90.85567474365234, -75.70088195800781, -39.494483947753906, -37.301116943359375, -36.14396667480469, -35.63461685180664, -33.967403411865234, -37.455074310302734, -72.94078826904297, -82.42282104492188, -70.1536636352539, -50.3256950378418, -46.22089767456055, -58.1534423828125, -77.5221939086914, -89.96234893798828, -93.55975341796875, },
                {-98.83784484863281, -94.85625457763672, -98.86465454101562, -95.30891418457031, -93.9515380859375, -93.25961303710938, -93.87240600585938, -94.31693267822266, -97.31400299072266, -93.07310485839844, -93.0472183227539, -91.57454681396484, -92.1005630493164, -96.7640380859375, -75.65912628173828, -42.2707405090332, -38.43328857421875, -43.60040283203125, -41.60764694213867, -40.750118255615234, -45.599056243896484, -82.47085571289062, -87.82337951660156, -75.04472351074219, -51.84370040893555, -54.52824401855469, -70.21858978271484, -87.79349517822266, -94.45451354980469, -98.07958984375, },
                {-98.03291320800781, -96.68832397460938, -98.70989990234375, -98.705322265625, -94.79595184326172, -95.45014953613281, -90.71033477783203, -95.34272766113281, -101.6518325805664, -96.22909545898438, -96.83998107910156, -95.77084350585938, -92.15739440917969, -91.25862884521484, -68.73505401611328, -49.838623046875, -38.6368522644043, -36.73517608642578, -38.2852783203125, -43.222084045410156, -54.53232192993164, -84.42528533935547, -86.30413818359375, -73.72752380371094, -33.516387939453125, -34.63962173461914, -44.20050048828125, -63.317222595214844, -83.1553726196289, -91.30224609375, },
                {-94.76461791992188, -98.66264343261719, -94.7025375366211, -100.00655364990234, -98.7795181274414, -96.08756256103516, -94.32567596435547, -95.29299926757812, -100.55755615234375, -94.00857543945312, -97.86087036132812, -98.49476623535156, -95.4212875366211, -94.95181274414062, -75.76365661621094, -56.37939453125, -49.200279235839844, -35.66952896118164, -33.87919616699219, -34.90517044067383, -45.617759704589844, -78.94961547851562, -78.60520935058594, -63.111846923828125, -22.740283966064453, -24.884605407714844, -40.11383056640625, -55.540809631347656, -75.72384643554688, -89.70984649658203, },
                {-94.35448455810547, -97.52674865722656, -97.70832061767578, -104.7104721069336, -95.88214111328125, -97.73883056640625, -93.90667724609375, -94.30683898925781, -95.36800384521484, -99.36894226074219, -101.2857666015625, -98.2731704711914, -98.24207305908203, -92.37640380859375, -93.68091583251953, -72.05938720703125, -47.99048614501953, -43.50982666015625, -42.88298797607422, -47.77561569213867, -65.81600952148438, -88.85346221923828, -89.93628692626953, -66.509033203125, -38.03825759887695, -33.764278411865234, -53.77311706542969, -68.08392333984375, -86.67422485351562, -99.29574584960938, },
                {-94.2391357421875, -100.28321075439453, -97.33399963378906, -103.96797180175781, -94.3426513671875, -97.60372924804688, -93.14330291748047, -94.84959411621094, -96.41777801513672, -99.58918762207031, -99.03205871582031, -98.655029296875, -92.63123321533203, -93.00094604492188, -94.920166015625, -84.50936126708984, -54.96341323852539, -53.69087219238281, -53.47101593017578, -62.59283447265625, -76.5088882446289, -95.51578521728516, -88.76374053955078, -64.05921173095703, -39.489234924316406, -45.02069854736328, -64.81886291503906, -86.86776733398438, -96.32664489746094, -99.76719665527344, },
                {-96.7367172241211, -102.25907897949219, -99.58794403076172, -95.79143524169922, -98.5848388671875, -95.06463623046875, -99.0279312133789, -98.03562927246094, -95.94667053222656, -97.17178344726562, -103.40412139892578, -98.44661712646484, -93.73457336425781, -93.56550598144531, -96.1056900024414, -80.48675537109375, -66.45327758789062, -74.1498794555664, -78.02447509765625, -82.85437774658203, -84.06855773925781, -96.86013793945312, -93.88446807861328, -60.98969268798828, -29.497020721435547, -30.91742706298828, -48.516029357910156, -68.68987274169922, -88.6751708984375, -93.07640075683594, },
                {-100.67595672607422, -98.54855346679688, -101.38175964355469, -99.21768188476562, -100.23917388916016, -96.26075744628906, -102.02174377441406, -97.67808532714844, -99.09862518310547, -97.77427673339844, -104.47688293457031, -97.32606506347656, -95.26362609863281, -96.0167236328125, -96.21337890625, -90.15129089355469, -74.24465942382812, -74.33268737792969, -83.58783721923828, -80.49220275878906, -87.23148345947266, -95.80268096923828, -91.51846313476562, -55.71338653564453, -24.78003692626953, -33.496707916259766, -48.76719665527344, -68.96471405029297, -81.9160385131836, -88.89640808105469, },
                {-98.58051300048828, -99.45608520507812, -101.91407012939453, -101.14389038085938, -100.7338638305664, -93.35757446289062, -100.2223129272461, -99.03216552734375, -99.30770874023438, -98.72454833984375, -100.11023712158203, -97.89482116699219, -95.09272766113281, -93.06316375732422, -97.05094909667969, -95.96929931640625, -70.2822265625, -63.42840576171875, -70.72344207763672, -68.07820892333984, -69.11180114746094, -87.85995483398438, -87.3820571899414, -36.94032669067383, -17.381189346313477, -29.14249610900879, -41.43082046508789, -64.75147247314453, -80.59396362304688, -91.3094253540039, },
                {-98.59547424316406, -100.8111572265625, -101.94624328613281, -97.40263366699219, -100.86808776855469, -97.01014709472656, -97.82889556884766, -99.42272186279297, -99.36278533935547, -101.6721420288086, -98.08055877685547, -94.23896789550781, -89.86420440673828, -82.56026458740234, -80.24323272705078, -80.1986312866211, -61.42102813720703, -52.10739517211914, -55.43649673461914, -59.30585861206055, -64.77923583984375, -87.78817749023438, -83.20446014404297, -23.47945785522461, -8.448040962219238, -26.333114624023438, -47.64582824707031, -68.6264877319336, -84.00654602050781, -92.49948120117188, },
                {-98.16486358642578, -101.26496124267578, -99.52678680419922, -96.31629943847656, -100.88179779052734, -98.662109375, -102.72681427001953, -97.46983337402344, -102.16741943359375, -100.33969116210938, -100.66470336914062, -95.33065795898438, -88.95724487304688, -78.79010009765625, -70.02364349365234, -71.66143798828125, -62.146522521972656, -51.975341796875, -56.440025329589844, -61.248863220214844, -67.47000885009766, -93.12691497802734, -82.87513732910156, -25.10753631591797, -13.525729179382324, -32.159217834472656, -53.59434509277344, -72.42985534667969, -88.37541198730469, -96.22654724121094, },
                {-100.51692199707031, -100.79714965820312, -100.17332458496094, -101.59686279296875, -100.94561767578125, -99.78353881835938, -99.64910888671875, -100.22000122070312, -102.4388198852539, -101.01211547851562, -102.89729309082031, -101.46621704101562, -98.28675842285156, -92.88960266113281, -82.95616912841797, -92.07418823242188, -65.13227081298828, -73.56078338623047, -72.56005859375, -75.42948150634766, -75.43553924560547, -92.59049987792969, -82.55595397949219, -38.14418029785156, -24.529109954833984, -42.82068634033203, -57.270477294921875, -74.68287658691406, -94.21884155273438, -97.36819458007812, },
                {-108.86630249023438, -106.91847229003906, -106.87081909179688, -107.23573303222656, -105.07205963134766, -107.65023803710938, -107.65116882324219, -107.44133758544922, -106.07180786132812, -106.81552124023438, -108.3326644897461, -108.37899017333984, -105.26241302490234, -103.49589538574219, -100.26277160644531, -97.67681121826172, -80.74214172363281, -75.73568725585938, -73.40609741210938, -71.0843505859375, -78.9946060180664, -100.44918823242188, -89.687255859375, -43.15683364868164, -31.92974281311035, -50.26619338989258, -66.56781005859375, -86.07486724853516, -101.7806396484375, -107.54379272460938, },
                {-120.8125, -120.8125, -120.8125, -120.8125, -120.8125, -120.8125, -120.8125, -120.8125, -120.8125, -120.8125, -120.54004669189453, -120.8125, -120.8125, -120.8125, -120.8125, -116.1453857421875, -107.48070526123047, -99.02317810058594, -92.323486328125, -87.21409606933594, -101.06170654296875, -120.8125, -108.96487426757812, -62.38610076904297, -54.67679977416992, -65.73918151855469, -82.52778625488281, -105.3694076538086, -119.19020080566406, -120.8125, },
        };

//uint16_t feature_maps[186][9][1];//__attribute__((section(".ARM.__at_0xC0000000")));
float fc_buffer1[128];
float fc_buffer2[128];

// float spectrogram[40][30];


int16_t conv_weight_q15[186][1][8][30];
int32_t conv_bias_q15[186];
int16_t fc1_weight_q15[32][1674];
int32_t fc1_bias_q15[32];
int16_t fc2_weight_q15[128][32];
int32_t fc2_bias_q15[128];
int16_t fc3_weight_q15[128][128];
int32_t fc3_bias_q15[128];
int16_t fc4_weight_q15[6][128];
int32_t fc4_bias_q15[6];

int16_t fc_buffer1_q15[128];
int16_t fc_buffer2_q15[128];

int16_t feature_maps_q15[186][9][1];
int16_t spectrogram_sample_q15[40][30];

char *label_names[] = {
	"background",
	"unknown",
	"left",
	"no",
	"right",
	"yes"
};

void Normalization(float values[], uint16_t len) {
    float mean = 0.f;
    float stddev = 0.f;

    arm_mean_f32(values, len, &mean);
    arm_std_f32(values, len, &stddev);

    while(len--) {
        *values = (*values - mean) / stddev;
        ++values;
    }

}

void Input_Quantization_toQ15 (float pIn[], int16_t pOut[], uint16_t len) {

    float maxAbsW = 0;
    for (int i = 0; i < len; ++i) {
        if (fabsf(pIn[i]) > maxAbsW) maxAbsW = fabsf(pIn[i]);
    }
    float factor = powf(2.f, 15.f - ceilf(log2f(maxAbsW))-1);

    printf("Layer: %s, max abs: %f, factor: %d\r\n", "feature_map", maxAbsW, (int)factor);

    for (int i = 0; i < len; ++i) {
        pOut[i] = (int16_t)roundf(pIn[i] * factor);
    }
}

void Weight_toQ15 (int lenW, int lenB, float pInW[], float pInB[], int16_t pOutW[], int32_t pOutB[], float biasFactor, char layerName[]) {
    float maxAbsW = 0;
    for (int i = 0; i < lenW; ++i) {
        if (fabsf(pInW[i]) > maxAbsW) maxAbsW = fabsf(pInW[i]);
    }
    for (int i = 0; i < lenB; ++i) {
        if (fabsf(pInB[i]) > maxAbsW) maxAbsW = fabsf(pInB[i]);
    }
    float factor = powf(2.f, 15.f - ceilf(log2f(maxAbsW)));
    biasFactor *= factor;

    printf("Layer: %s, max abs: %f, factor: %d\r\n", layerName, maxAbsW, (int)factor);

    for (int i = 0; i < lenW; ++i) {
        pOutW[i] = (int16_t)roundf(pInW[i] * factor);
    }
    for (int i = 0; i < lenB; ++i) {
        pOutB[i] = (int32_t)roundf(pInB[i] * biasFactor);
    }
}

void Conv2D_Relu(uint16_t inCh, uint16_t inRow, uint16_t inCol, float inFeature[][inRow][inCol], 
				uint16_t outCh, uint16_t outRow, uint16_t outCol, float outFeature[][outRow][outCol],
				uint16_t kernelRow, uint16_t kernelCol,
				uint16_t strideRow, uint16_t strideCol,
				float kernel[][inCh][kernelRow][kernelCol], float bias[])
{
	
	for (uint16_t out_ch = 0; out_ch < outCh; ++out_ch ){
		for (uint16_t out_row = 0; out_row < outRow; ++out_row){
			for (uint16_t out_col = 0; out_col < outCol; ++out_col){
				
				outFeature[out_ch][out_row][out_col] = bias[out_ch];
				
				for (uint16_t in_ch = 0; in_ch < inCh; ++in_ch ){
					for (uint8_t i = 0; i < kernelRow; ++i){
						for (uint8_t j = 0; j < kernelCol; ++j){
							outFeature[out_ch][out_row][out_col] += 
							inFeature[in_ch][out_row * strideRow + i][out_col * strideCol + j] * kernel[out_ch][in_ch][i][j];
						}
					}
				}
				// Relu
				RELU(outFeature[out_ch][out_row][out_col]);
			}
			
		}
	}
	
}

void Conv2D_Relu_q15(uint16_t inCh, uint16_t inRow, uint16_t inCol, int16_t inFeature[][inRow][inCol],
                 uint16_t outCh, uint16_t outRow, uint16_t outCol, int16_t outFeature[][outRow][outCol],
                 uint16_t kernelRow, uint16_t kernelCol,
                 uint16_t strideRow, uint16_t strideCol,
                 int16_t kernel[][inCh][kernelRow][kernelCol], int32_t bias[], int asr)
{

    for (uint16_t out_ch = 0; out_ch < outCh; ++out_ch ){
        for (uint16_t out_row = 0; out_row < outRow; ++out_row){
            for (uint16_t out_col = 0; out_col < outCol; ++out_col){

                register int32_t outV = bias[out_ch];
                // outFeature[out_ch][out_row][out_col] = bias[out_ch];

                for (uint16_t in_ch = 0; in_ch < inCh; ++in_ch ){
                    for (uint8_t i = 0; i < kernelRow; ++i){
                        for (uint8_t j = 0; j < kernelCol; ++j){
                            outV += inFeature[in_ch][out_row * strideRow + i][out_col * strideCol + j] * kernel[out_ch][in_ch][i][j];
                        }
                    }
                }
                // Relu
                RELU(outV);
                outFeature[out_ch][out_row][out_col] = (int16_t)(outV >> asr);
            }

        }
    }

}

void Fully_Connected(float inVec[], uint16_t inLen, float outVec[], uint16_t outLen, float weights[][inLen], float bias[]) {
    for (uint16_t i = 0; i < outLen; ++i) {
        outVec[i] = bias[i];
        for (uint16_t j = 0; j < inLen; ++j) {
            outVec[i] += inVec[j] * weights[i][j];
        }
    }
}

void Relu(float vec[], uint16_t len) {
    for (uint16_t i = 0; i < len; ++i) {
        RELU(vec[i]);
    }
}

void Fully_Connected_q15(int16_t inVec[], uint16_t inLen, int16_t outVec[], uint16_t outLen, int16_t weights[][inLen], int32_t bias[], int asr) {
    for (uint16_t i = 0; i < outLen; ++i) {
        register int outV = bias[i];
        for (uint16_t j = 0; j < inLen; ++j) {
            outV += inVec[j] * weights[i][j];
        }

        outVec[i] = (int16_t)(outV >> asr);
    }
}

void FC_Relu(float inVec[], uint16_t inLen, float outVec[], uint16_t outLen, float weights[][inLen], float bias[]) {
	for (uint16_t i = 0; i < outLen; ++i) {
		outVec[i] = bias[i];
		for (uint16_t j = 0; j < inLen; ++j) {
			outVec[i] += inVec[j] * weights[i][j];
		}
		RELU(outVec[i]);
	}
}

void FC_Relu_q15(int16_t inVec[], uint16_t inLen, int16_t outVec[], uint16_t outLen, int16_t weights[][inLen], int32_t bias[], int asr) {
    for (uint16_t i = 0; i < outLen; ++i) {
        register int outV = bias[i];
        for (uint16_t j = 0; j < inLen; ++j) {
            outV += inVec[j] * weights[i][j];
        }
        RELU(outV);
        outVec[i] = (int16_t)(outV >> asr);
    }
}

void Softmax(float inVec[], float outVec[], uint16_t len) {
	float exp_sum = 0;
	for (uint16_t i = 0; i < len; ++i) {
		exp_sum += outVec[i] = expf(inVec[i]);
	}
	for (uint16_t i = 0; i < len; ++i) {
		outVec[i] /= exp_sum;
	}
}

void Forward() {
	
	// Get_Spectrogram(spectrogram);

    Normalization(spectrogram[0], 30 * 40);

	Conv2D_Relu(1, 40, 30, &spectrogram, 186, 9, 1, feature_maps, 8, 30, 4, 1, conv_weight, conv_bias);

    for (float* p = (float*)feature_maps; p < (float*)feature_maps + 20; ++p) {
        printf("%f ", *p);
    }
    printf("\n");

    FC_Relu((void*)feature_maps, 186*9*1, fc_buffer1, 32, fc1_weight, fc1_bias);
	FC_Relu(fc_buffer1, 32, fc_buffer2, 128, fc2_weight, fc2_bias);
	FC_Relu(fc_buffer2, 128, fc_buffer1, 128, fc3_weight, fc3_bias);
    Fully_Connected(fc_buffer1, 128, fc_buffer2, 6, fc4_weight, fc4_bias);
	Softmax(fc_buffer2, fc_buffer1, 6);
	
	for (uint16_t i = 0; i < 6; ++i) {
		printf("%s\t\t%.2f\n", label_names[i], fc_buffer2[i]);
	}
	printf("\n\n");

    for (uint16_t i = 0; i < 6; ++i) {
        printf("%s\t\t%.1f%%\n", label_names[i], fc_buffer1[i] * 100.f);
    }
    printf("\n\n");
	
}

void Forward_q15 () {

    Normalization(spectrogram[0], 30 * 40);

    Input_Quantization_toQ15((void*)spectrogram, (void*)spectrogram_sample_q15, 30 * 40);

    Weight_toQ15(186*1*8*30, 186, (void*)conv_weight, conv_bias, (void*)conv_weight_q15, conv_bias_q15, 12, "conv");
    Weight_toQ15(32*1674, 32, (void*)fc1_weight, fc1_bias, (void*)fc1_weight_q15, fc1_bias_q15, 10, "fc1");
    Weight_toQ15(128*32, 128, (void*)fc2_weight, fc2_bias, (void*)fc2_weight_q15, fc2_bias_q15, 8, "fc2");
    Weight_toQ15(128*128, 128, (void*)fc3_weight, fc3_bias, (void*)fc3_weight_q15, fc3_bias_q15, 7, "fc3");
    Weight_toQ15(6*128, 6, (void*)fc4_weight, fc4_bias, (void*)fc4_weight_q15, fc4_bias_q15, 7, "fc4");

    Conv2D_Relu_q15(1, 40, 30, (void*)spectrogram_sample_q15, 186, 9, 1, feature_maps_q15, 8, 30, 4, 1, conv_weight_q15, conv_bias_q15, 16);

    for (int16_t* p = (int16_t*)feature_maps_q15; p < (int16_t*)feature_maps_q15 +20; ++p) {
        printf("%f ", *p / powf(2, 10));
    }
    printf("\n");

    FC_Relu_q15((void*)feature_maps_q15, 186*9*1, fc_buffer1_q15, 32, fc1_weight_q15, fc1_bias_q15, 16);
    FC_Relu_q15(fc_buffer1_q15, 32, fc_buffer2_q15, 128, fc2_weight_q15, fc2_bias_q15, 15);
    FC_Relu_q15(fc_buffer2_q15, 128, fc_buffer1_q15, 128, fc3_weight_q15, fc3_bias_q15, 14);
    Fully_Connected_q15(fc_buffer1_q15, 128, fc_buffer2_q15, 6, fc4_weight_q15, fc4_bias_q15, 14);

    for (uint16_t i = 0; i < 6; ++i) {
        printf("%s\t\t%d\t%f\n", label_names[i], fc_buffer2_q15[i], fc_buffer2_q15[i]/ powf(2,7));
    }
    printf("\n\n");

    printf("0");
}

void Print_Conv(uint16_t outCh, uint16_t inCh, uint16_t kernelRow, uint16_t kernelCol, int16_t weights[outCh][inCh][kernelRow][kernelCol]) {
    printf("int16_t conv_weight_q15[%d][%d][%d][%d] = {\n", outCh, inCh, kernelRow, kernelCol);
    for (uint16_t out_ch = 0; out_ch < outCh; ++out_ch ) {
        printf("\t{\n");
        for (uint16_t in_ch = 0; in_ch < inCh; ++in_ch) {
            printf("\t\t{\n");
            for (uint16_t i = 0; i < kernelRow; ++i) {
                printf("\t\t\t{");
                for (uint16_t j = 0; j < kernelCol; ++j) {
                    printf("%d, ", weights[out_ch][in_ch][i][j]);
                }
                printf("},\n");
            }
            printf("\t\t},\n");
        }
        printf("\t},\n");
    }
    printf("};\n");
}

void PrintFc(uint16_t outCh, uint16_t inCh, int16_t weights[outCh][inCh], char layerName[]) {
    printf("int16_t %s_weight_q15[%d][%d] = {\n", layerName, outCh, inCh);
    for (uint16_t out_ch = 0; out_ch < outCh; ++out_ch ) {
        printf("\t{");
        for (uint16_t in_ch = 0; in_ch < inCh; ++in_ch) {
            printf("%d, ", weights[out_ch][in_ch]);
        }
        printf("},\n");
    }
    printf("};\n");
}

void PrintBias(uint16_t len, int32_t weights[], char layerName[]) {
    printf("int32_t %s_bias_q15[%d] = {\n", layerName, len);
    for (uint16_t out_ch = 0; out_ch < len; ++out_ch ) {
            printf("%d, ", weights[out_ch]);
    }
    printf("};\n");
}

int main() {
    setbuf(stdout,NULL);

    Forward();
    Forward_q15();

    freopen("cnn_one_fstride4_q15.c", "w", stdout);

    Print_Conv(186, 1, 8, 30, conv_weight_q15);
    PrintFc(32, 1674, fc1_weight_q15, "fc1");
    PrintFc(128, 32, fc2_weight_q15, "fc2");
    PrintFc(128, 128, fc3_weight_q15, "fc3");
    PrintFc(6, 128, fc4_weight_q15, "fc4");

    PrintBias(186, conv_bias_q15, "conv");
    PrintBias(32, fc1_bias_q15, "fc1");
    PrintBias(128, fc2_bias_q15, "fc2");
    PrintBias(128, fc3_bias_q15, "fc3");
    PrintBias(6, fc4_bias_q15, "fc4");


    return 0;
}


